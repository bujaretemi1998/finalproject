name: Docker Image CI

on:
  push:
    branches: none # [ "master" ]
  pull_request:
    branches: none #[ "master" ]

jobs:
  
  before_install:
    runs-on: linux
    steps:
    - uses: actions/checkout@v3
    - name: Build the test
      run: docker build -t bujaretemi1998/react-test -f ./client/Dockerfile.dev ./client

  script:
    runs-on: linux
    steps:
    - uses: actions/checkout@v3
    - name: Run the test
      run: docker run bujaretemi1998/react-test npm test -- --coverage
  
  after_success:
    runs-on: linux
    steps:
    - uses: actions/checkout@v3
    - name: Build the Docker images
      run: docker build -t bujaretemi1998/multi-client ./client,
           docker build -t bujaretemi1998/multi-nginx ./nginx,
           docker build -t bujaretemi1998/multi-server ./server,
           docker build -t bujaretemi1998/multi-worker ./worker,
           echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin,
           docker push bujaretemi1998/multi-client,
           docker push bujaretemi1998/multi-nginx,
           docker push bujaretemi1998/multi-server,
           docker push bujaretemi1998/multi-worker
